# VSCODE PowerPack snippets
This file contains snippets useful for PowerPacks.

## PowerPack template
In the installation or uninstallation script delete all and use the following snippet instead.
```json
    "PowerPackTemplateInstall": {
		"prefix": "PowerPackTemplateInstall",
		"body": [
			"[CmdletBinding()]",
			"Param(",
			"  [Parameter(Mandatory = $$true)]",
			"  [string]$$Packageroot,",
			"  [Parameter(Mandatory = $$true)]",
			"  [string]$$AppName,",
			"  [Parameter(Mandatory = $$true)]",
			"  [string]$$AppRelease,",
			"  [Parameter(Mandatory = $$true)]",
			"  [string]$$LogFile,",
			"  [Parameter(Mandatory = $$true)]",
			"  [string]$$TempFolder,",
			"  [Parameter(Mandatory = $$true)]",
			"  [string]$$DllPath,",
			"  [Parameter(Mandatory = $$false)]",
			"  [Object]$$InputObject = $$null",
			")",
			"",
			"Import-Module Capa.PowerShell.Module.PowerPack",
			"##################",
			"### PARAMETERS ###",
			"##################",
			"# DO NOT CHANGE",
			"[bool]$$global:DownloadPackage = $$true",
			"$$Global:Packageroot = $$Packageroot",
			"$$Global:AppName = $$AppName",
			"$$Global:AppRelease = $$AppRelease",
			"$$Global:LogFile = $$LogFile",
			"$$Global:TempFolder = $$TempFolder",
			"$$Global:DllPath = $$DllPath",
			"$$Global:InputObject = $$InputObject",
			"# Change as needed",
			"",
			"#################",
			"### FUNCTIONS ###",
			"#################",
			"function Begin {",
			"  ##############################################",
			"  #load Library dll",
			"  $$Global:Cs = Add-PpDll -DllPath $$Global:DllPath",
			"  ##############################################",
			"",
			"  #Begin",
			"  Job_Start -JobType 'WS' -PackageName $$Global:AppName -PackageVersion $$Global:AppRelease -LogPath $$Global:LogFile -Action 'INSTALL'",
			"  Log_SectionHeader -Name 'Begin'",
			"  Job_WriteLog -Text (\"[Init]: Starting package: '\" + $$Global:AppName + \"' Release: '\" + $$Global:AppRelease + \"'\")",
			"  If (!(Sys_IsMinimumRequiredDiskspaceAvailable -Drive 'c:' -MinimumRequiredDiskspace 1500)) { Exit-PpMissingDiskSpace }",
			"  If ($$global:DownloadPackage -and $$Global:InputObject) { Start-PSDownloadPackage }",
			"",
			"  Job_WriteLog -Text (\"[Init]: `$$Global:Packageroot:` '\" + $$Global:Packageroot + \"'\")",
			"  Job_WriteLog -Text (\"[Init]: `$$Global:AppName:` '\" + $$Global:AppName + \"'\")",
			"  Job_WriteLog -Text (\"[Init]: `$$Global:AppRelease:` '\" + $$Global:AppRelease + \"'\")",
			"  Job_WriteLog -Text (\"[Init]: `$$Global:LogFile:` '\" + $$Global:LogFile + \"'\")",
			"  Job_WriteLog -Text (\"[Init]: `$$Global:TempFolder:` '\" + $$Global:TempFolder + \"'\")",
			"  Job_WriteLog -Text (\"[Init]: `$$Global:DllPath:` '\" + $$Global:DllPath + \"'\")",
			"  Job_WriteLog -Text (\"[Init]: `$$global:DownloadPackage`: '\" + $$global:DownloadPackage + \"'\")",
			"}",
			"",
			"function PreInstall {",
			"  Log_SectionHeader -Name 'PreInstall'",
			"}",
			"",
			"function Install {",
			"  Log_SectionHeader -Name 'Install'",
			"}",
			"",
			"function PostInstall {",
			"  Log_SectionHeader -Name 'PostInstall'",
			"}",
			"############",
			"### Main ###",
			"############",
			"try {",
			"  Begin -InputObject $$Global:InputObject -Packageroot $$Global:Packageroot -AppName $$Global:AppName -AppRelease $$Global:AppRelease -LogFile $$Global:LogFile -TempFolder $$Global:TempFolder -DllPath $$Global:DllPath",
			"  PreInstall",
			"  Install",
			"  PostInstall",
			"  Exit-PpScript $$Error",
			"} catch {",
			"  $$line = $$_.InvocationInfo.ScriptLineNumber",
			"  Job_WriteLog -FunctionName '*****************' -Text \"Something bad happend at line $$($$line): $$($$_.Exception.Message)\"",
			"  Exit-PpScript $$_.Exception.HResult",
			"}",
			""
		]
	}
```

## Exe template
```json
"PowerPackExeExcution": {
		"prefix": "PowerPackExeExcution",
		"description": "Template for a PowerShell exe excution in CapaInstaller PowerPacks",
		"body": [
			"$$Command = \"$$Global:Packageroot\\kit\\chrome.exe\"",
			"$$Arguments = '/SILENT'",
			"$RetValue = Shell_Execute -Command $$Command -Arguments $$Arguments",
			"",
			"if ($$RetValue -ne 0) { Exit-PpScript $RetValue }",
			"Job_WriteLog -FunctionName 'Install' -Text \"$$Global:AppName completed with status: $$RetValue\""
		]
	}
```

## PowerPackInstallMSI
```json
"PowerPackInstallMSI": {
		"prefix": "PowerPackInstallMSI",
		"body": [
			"$$MSIInstallLog = Join-Path $$Global:MSILogDir \"Appl_Install_$($$Global:AppName).log\"",
			"",
			"\t$$Splatting = @{",
			"\t\tCommand     = 'msiexec.exe'",
			"\t\tArguments   = \"/i `\"$$Global:MSIFile`\" /QN REBOOT=REALLYSUPPRESS ALLUSERS=1 /L* `\"$$MSIInstallLog`\"\"",
			"\t\tWait        = $$true",
			"\t\tWindowStyle = 'Hidden'",
			"\t\tMustExist   = $$false",
			"\t}",
			"\t$$RetValue = Shell_Execute @Splatting",
			"",
			"\tif ($$RetValue -ne 0) {",
			"\t\tExit-PpScript $$RetValue",
			"\t}",
			"\tJob_WriteLog -Text \"$$Global:AppName completed with status: $$RetValue\""
		],
		"description": "Used in PowerPack scripts to install MSI packages. To be used together with PowerPackUninstallProgramFunctions and PowerPackUninstallProgram. Requmented to be used in Install part og the installation script."
	}
```

## PowerPackUninstallProgram
```json
"PowerPackUninstallProgram": {
		"prefix": "PowerPackUninstallProgram",
		"body": [
			"\t$$Global:MSILogDir = Join-Path $$Global:gsLogDir 'Msilogs'",
			"\t$$Global:MSIUninstallLog = Join-Path $$Global:MSILogDir \"Appl_Uninstall_$($$Global:AppName).log\"",
			"",
			"\t# TODO: Change this to the MSI file you want to install",
			"\t$$Global:MSIFile = Join-Path $$Global:Packageroot 'kit' 'script.msi'",
			"\t$$Guid = MSI_GetProductCodeFromMSI -MsiFile $$Global:MSIFile",
			"",
			"\tif ($$Guid -eq $$null) {",
			"\t\tExit-PpCommandFailed -ExitMessage 'Failed to get ProductCode from MSI'",
			"\t}",
			"",
			"\tif (!(File_ExistDir -Path $$Global:MSILogDir)) {",
			"\t\tFile_CreateDir -Path $$Global:MSILogDir",
			"\t}",
			"",
			"\tUninstall-Guid -Guid $$Guid",
			"",
			"\t##region Uninstall based on registry",
			"\t$$RegPath = 'Software\\Microsoft\\Windows\\CurrentVersion\\Uninstall'",
			"\tUninstall-WhatIsFoundInRegistry -RegPath $$RegPath",
			"",
			"\t$$RegPath = 'Software\\WOW6432Node\\Microsoft\\Windows\\CurrentVersion\\Uninstall'",
			"\tUninstall-WhatIsFoundInRegistry -RegPath $$RegPath",
			"\t#endregion"
		],
		"description": "Used in PowerPack together with PowerPackUninstallProgramFunctions to uninstall a program. Recommended to be inserted in PreInstall in the intallation script or in Uninstall in the uninstallation script."
	}
```

## PowerPackUninstallProgramFunctions
```json
"PowerPackUninstallProgramFunctions": {
		"prefix": "PowerPackUninstallProgramFunctions",
		"body": [
			"function Uninstall-Guid {",
			"\tparam (",
			"\t\t[Parameter(Mandatory = $$true)]",
			"\t\t[string]$$Guid",
			"\t)",
			"",
			"\t$$Installed = MSI_IsMSIGuidInstalled -MsiGuid $$Guid",
			"\tif ($$Installed) {",
			"\t\t$$Splatting = @{",
			"\t\t\tCommand     = 'msiexec.exe'",
			"\t\t\tArguments   = \"/x $$Guid /qn REBOOT=REALLYSUPPRESS ALLUSERS=2 /L* `\"$$Global:MSIUninstallLog`\"\"",
			"\t\t\tWait        = $$true",
			"\t\t\tWindowStyle = 'Hidden'",
			"\t\t\tMustExist   = $$false",
			"\t\t}",
			"\t\t$$RetValue = Shell_Execute @Splatting",
			"",
			"\t\tif ($$RetValue -ne 0) {",
			"\t\t\tExit-PpCommandFailed -ExitMessage 'Failed to uninstall MSI'",
			"\t\t}",
			"\t\tJob_WriteLog -Text \"Uninstall completed with status: $$RetValue\"",
			"\t}",
			"}",
			"",
			"function Uninstall-UsingUninstallString {",
			"\tparam (",
			"\t\t[Parameter(Mandatory = $$true)]",
			"\t\t[string]$$Uninstallstring",
			"\t)",
			"\t$$RetValue = Shell_Execute -Command $$Uninstallstring -Arguments '/S' -Wait $$true -WindowStyle Hidden -MustExist $$false",
			"\tif ($$RetValue -ne 0) { Exit-PpScript $$RetValue }",
			"\tJob_WriteLog -Text \"Command completed with status: $$RetValue\"",
			"}",
			"",
			"function Uninstall-WhatIsFoundInRegistry {",
			"\tparam (",
			"\t\t[Parameter(Mandatory = $$true)]",
			"\t\t[string]$$RegPath",
			"\t)",
			"\t$$Keys = Reg_EnumKey -RegRoot HKLM -RegPath $$RegPath -MustExist $$true",
			"",
			"\t# TODO: Update this to match the application you are packaging. You can see 3 different examples below.",
			"\t<#",
			"\t$$Keys = $$Keys | Where-Object { $$_ -like '*Firefox*' }",
			"\tforeach ($$Item in $$Keys) {",
			"\t\tJob_WriteLog -Text \"Key: $$Item\"",
			"\t\t$$UninstallString = Reg_GetString -RegRoot HKLM -RegKey \"$$RegPath\\$$Item\" -RegValue 'UninstallString'",
			"\t\tCustom-Uninstall -Uninstallstring $$UninstallString",
			"\t}",
			"\t#>",
			"",
			"\t<#",
			"\tforeach ($$Item in $$Keys) {",
			"\t\tJob_WriteLog -Text \"Running for key: $$Item\"",
			"\t\t$$Publisher = Reg_GetString -RegRoot HKLM -RegKey \"$$RegPath\\$$Item\" -RegValue 'Publisher'",
			"\t\t$$DisplayName = Reg_GetString -RegRoot HKLM -RegKey \"$$RegPath\\$$Item\" -RegValue 'DisplayName'",
			"",
			"\t\tif ($$Publisher -eq 'ACD/Labs' -and $$DisplayName -like '*Freeware*' -and $$DisplayName -like '*ACD64FREE*') {",
			"\t\t\t$$UninstallString = Reg_GetString -RegRoot HKLM -RegKey \"$$RegPath\\$$Item\" -RegValue 'UninstallString'",
			"\t\t\tUninstall-UsingUninstallString -Uninstallstring $$UninstallString",
			"\t\t} else {",
			"\t\t\tJob_WriteLog -Text \"Skipping uninstall for key: $$Item\"",
			"\t\t}",
			"\t}",
			"\t#>",
			"",
			"\t<#",
			"\tforeach ($$Item in $$Keys) {",
			"\t\tJob_WriteLog -Text \"Running for key: $$Item\"",
			"\t\t$$Publisher = Reg_GetString -RegRoot HKLM -RegKey \"$$RegPath\\$$Item\" -RegValue 'Publisher'",
			"\t\t$$DisplayName = Reg_GetString -RegRoot HKLM -RegKey \"$$RegPath\\$$Item\" -RegValue 'DisplayName'",
			"",
			"\t\tif ($$Publisher -eq 'ACD/Labs' -and $$DisplayName -like '*Freeware*' -and $$DisplayName -like '*ACD64FREE*') {",
			"\t\t\t$$UninstallString = Reg_GetString -RegRoot HKLM -RegKey \"$$RegPath\\$$Item\" -RegValue 'UninstallString'",
			"\t\t\t$$UninstallString = $$UninstallString -replace 'msiexec.exe /I', ''",
			"\t\t\tUninstall-Guid -Guid $$UninstallString",
			"\t\t} else {",
			"\t\t\tJob_WriteLog -Text \"Skipping uninstall for key: $$Item\"",
			"\t\t}",
			"\t}",
			"\t#>",
			"}"
		],
		"description": "Can be used in PowerPack to uninstall a program using GUID, UninstallString or Registry."
	}
```
